<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Checkout | Big Uncle Technologies</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f8fc;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 3rem 2rem;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
      text-align: center;
      width: 100%;
      max-width: 420px;
    }
    h1 {
      color: #1a202c;
      margin-bottom: 1rem;
      font-size: 1.8rem;
    }
    #status {
      font-size: 1rem;
      color: #4a5568;
      margin-bottom: 2rem;
    }
    .spinner {
      border: 4px solid #eee;
      border-top: 4px solid #007aff;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      margin: 0 auto 1rem auto;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .support {
      font-size: 0.9rem;
      color: #666;
      margin-top: 1rem;
    }
    .support a {
      color: #007aff;
      text-decoration: none;
    }
    .support a:hover {
      text-decoration: underline;
    }
    .error {
      color: #e53e3e;
      margin-top: 1rem;
      padding: 1rem;
      background: #fff5f5;
      border-radius: 8px;
      text-align: left;
      font-size: 0.9rem;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
  <script type="module">
    // Add error display function
    function showError(message, details = null) {
      const status = document.getElementById("status");
      const spinner = document.querySelector(".spinner");
      
      spinner.style.display = "none";
      status.innerText = message || "An error occurred";
      
      // Create error details element if there are details to show
      if (details) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = typeof details === 'object' ? JSON.stringify(details, null, 2) : details.toString();
        document.querySelector(".card").appendChild(errorDiv);
      }
    }

    // Wrap everything in a try-catch to catch any initialization errors
    try {
      // Import Supabase client
      const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
      
      const supabase = createClient(
        'https://aubpfeohfhuitytohjyu.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1YnBmZW9oZmh1aXR5dG9oanl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMDc0MjgsImV4cCI6MjA2ODU4MzQyOH0.XYtk6yRoju-on48lWaudptFNyw7Or4IaGkAQY15jwzo'
      );

      // Main function
      window.onload = async () => {
        const params = new URLSearchParams(window.location.search);
        const planSlug = params.get("plan");
        const status = document.getElementById("status");

        if (!planSlug) {
          showError("No plan selected. Please go back and try again.");
          return;
        }

        status.innerText = "Retrieving plan details...";

        try {
          // First try using the RPC function
          let planData;
          try {
            const { data, error } = await supabase
              .rpc("get_pricing_plan_by_slug", { plan_slug: planSlug });
            
            if (error) throw error;
            planData = data;
          } catch (rpcError) {
            console.warn("RPC function failed, falling back to direct query:", rpcError);
            
            // Fallback to direct query if RPC doesn't exist
            const { data, error } = await supabase
              .from("pricing_plans")
              .select("*")
              .eq("slug", planSlug)
              .eq("is_active", true)
              .single();
              
            if (error) throw error;
            planData = data;
          }

          if (!planData) {
            showError("Invalid or inactive plan. Please contact support.");
            return;
          }

          // If no amount, assume Enterprise (Contact for pricing)
          if (!planData.amount) {
            showError(`This plan requires a custom quote.<br/><br/>
              <a href="https://wa.me/233543899498" target="_blank">Click here to contact support</a>.`);
            return;
          }

          // Simple form for customer information
          const card = document.querySelector(".card");
          document.querySelector(".spinner").style.display = "none";
          
          status.innerHTML = `
            <strong>${planData.name}</strong><br>
            Amount: ${planData.currency || 'GHS'} ${planData.amount.toFixed(2)}
          `;
          
          const form = document.createElement("form");
          form.innerHTML = `
            <div style="margin: 20px 0; text-align: left;">
              <label style="display: block; margin-bottom: 5px;">Email Address</label>
              <input type="email" id="email" required placeholder="your@email.com" 
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
              
              <label style="display: block; margin-bottom: 5px;">Phone Number (with country code)</label>
              <input type="tel" id="phone" required placeholder="e.g., 233543899498"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
              
              <button type="submit" style="background: #007aff; color: white; border: none; 
                border-radius: 4px; padding: 12px; width: 100%; cursor: pointer; font-size: 16px;">
                Proceed to Payment
              </button>
            </div>
          `;
          
          card.appendChild(form);
          
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const customerEmail = document.getElementById("email").value;
            const customerPhone = document.getElementById("phone").value;
            
            // Show loading state
            const submitBtn = form.querySelector("button");
            submitBtn.disabled = true;
            submitBtn.textContent = "Processing...";
            status.textContent = "Connecting to secure payment gateway...";
            document.querySelector(".spinner").style.display = "block";
            
            try {
              // Call the Edge Function
              const response = await fetch(
                "https://aubpfeohfhuitytohjyu.supabase.co/functions/v1/hubtel-payment-proxy",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    planSlug: planSlug,
                    customerEmail: customerEmail,
                    customerPhone: customerPhone,
                    returnUrl: "https://checkout.biguncletech.com/result",
                    callbackUrl: "https://aubpfeohfhuitytohjyu.supabase.co/functions/v1/hubtel-callback"
                  })
                }
              );

              const result = await response.json();
              
              if (response.ok && result.checkoutUrl) {
                status.innerText = "Redirecting to secure payment page...";
                setTimeout(() => {
                  window.location.href = result.checkoutUrl;
                }, 1000);
              } else {
                throw new Error(result.error || "Payment initialization failed");
              }
            } catch (err) {
              showError("Payment initialization failed", err);
              submitBtn.disabled = false;
              submitBtn.textContent = "Try Again";
              document.querySelector(".spinner").style.display = "none";
            }
          });
          
        } catch (err) {
          showError("Failed to retrieve plan details", err);
        }
      };
    } catch (initError) {
      // Catch any errors during initialization
      document.addEventListener('DOMContentLoaded', () => {
        showError("Failed to initialize checkout", initError);
      });
    }
  </script>
</head>
<body>
  <div class="card">
    <div class="spinner"></div>
    <h1>Secure Checkout</h1>
    <p id="status">Preparing your checkout session...</p>
    <div class="support">
      Need help? <a href="https://wa.me/233543899498" target="_blank">Contact Support</a>
    </div>
  </div>
</body>
</html>
