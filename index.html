<!DOCTYPE html>

<html lang=
"en"
>

<head>

  <meta charset=
"UTF-8"
>

  <meta name=
"viewport"
 content=
"width=device-width, initial-scale=1.0"
>

  <title>Debug Checkout</title>

  <style>

    body { font-family: Arial, sans-serif; max-width: 
600
px; margin: 
40
px auto; padding: 
20
px; }

    .debug { background: 
#f0f0f0; padding: 10px; border-radius: 4px; white-space: pre-wrap; margin: 10px 0; }


    button { padding: 
10
px 
15
px; background: 
#4CAF50; color: white; border: none; cursor: pointer; }


    input { padding: 
8
px; margin: 
5
px 
0
 
15
px; width: 
100
%; }

  </style>

</head>

<body>

  <h1>Debug Checkout</h1>

  <div id=
"log"
 
class
=
"debug"
>Loading...</div>

  <div id=
"form-container"
 style=
"display:none;"
>

    <h2>Enter Payment Details</h2>

    <form id=
"payment-form"
>

      <label 
for
=
"email"
>Email:</label>

      <input type=
"email"
 id=
"email"
 required 
value
=
"test@example.com"
>

      <label 
for
=
"phone"
>Phone:</label>

      <input type=
"tel"
 id=
"phone"
 required 
value
=
"233543899498"
>

      <button type=
"submit"
>Process Payment</button>

    </form>

  </div>

  <div id=
"error-container"
 style=
"display:none; color:red; margin-top:20px;"
></div>

  <script>

    
// Debug logger


    
const
 log = document.getElementById(
'log'
);

    
const
 formContainer = document.getElementById(
'form-container'
);

    
const
 errorContainer = document.getElementById(
'error-container'
);

    
function 
addLog
(
message
)
 {

      
const
 timestamp = 
new
 Date().toLocaleTimeString();

      log.textContent += `\n[${timestamp}] ${message}`;

      log.scrollTop = log.scrollHeight;

      console.log(`[${timestamp}] ${message}`);

    }

    
function 
showError
(
message, details
)
 {

      errorContainer.style.display = 
'block'
;

      errorContainer.innerHTML = `<h3>Error</h3><p>${message}</p>`;

      
if
 (details) {

        
const
 detailsElement = document.createElement(
'pre'
);

        detailsElement.textContent = 
typeof
 details === 
'object'
 ? JSON.stringify(details, 
null
, 
2
) : details;

        errorContainer.appendChild(detailsElement);

      }

      addLog(`ERROR: ${message}`);

    }

    
// Get URL parameters


    
const
 
params
 = 
new
 URLSearchParams(window.location.search);

    
const
 planSlug = 
params
.
get
(
'plan'
) || 
'web-basic'
;

    addLog(`Starting checkout 
for
 plan: ${planSlug}`);

    
// Hard-coded plan data as fallback


    
const
 fallbackPlan = {

      name: 
"Web Basic Plan"
,

      amount: 
1500
,

      currency: 
"GHS"
,

      description: 
"Basic website package"


    };

    
//Initialise checkout


    
async
 function 
initCheckout
(
)
 {

      
try
 {

        addLog(
'Fetching plan data...'
);

        
// Try to get plan data from API


        
let
 planData;

        
try
 {

          
const
 response = 
await
 fetch(`https:
//aubpfeohfhuitytohjyu.supabase.co/rest/v1/pricing_plans?slug=eq.${planSlug}&select=*`, {


            headers: {

              
'apikey'
: 
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1YnBmZW9oZmh1aXR5dG9oanl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMDc0MjgsImV4cCI6MjA2ODU4MzQyOH0.XYtk6yRoju-on48lWaudptFNyw7Or4IaGkAQY15jwzo'


            }

          });

          addLog(`API response status: ${response.status}`);

          
if
 (response.ok) {

            
const
 data = 
await
 response.json();

            addLog(`API returned data: ${JSON.stringify(data)}`);

            
if
 (data && data.length > 
0
) {

              planData = data[
0
];

              addLog(`Using plan data 
from
 API: ${planData.name}, ${planData.currency} ${planData.amount}`);

            } 
else
 {

              
throw
 
new
 Error(
"Plan not found in API response"
);

            }

          } 
else
 {

            
const
 errorText = 
await
 response.text();

            
throw
 
new
 Error(`
API 
error
 (
${response.status}
): $
{errorText}`);

          }

        } catch (err) {

          addLog(`Failed to fetch plan data: ${err.message}`);

          addLog(
'Using fallback plan data'
);

          planData = fallbackPlan;

        }

        
// Show form


        formContainer.style.display = 
'block'
;

        addLog(
'Checkout form ready'
);

        
// Handle form submission


        document.getElementById(
'payment-form'
).addEventListener(
'submit'
, 
async
 (e) => {

          e.preventDefault();

          
const
 email = document.getElementById(
'email'
).
value
;

          
const
 phone = document.getElementById(
'phone'
).
value
;

          addLog(`Processing payment 
for
 ${email} / ${phone}`);

          
try
 {

            addLog(
'Calling hubtel-payment-proxy Edge Function...'
);

            
const
 paymentResponse = 
await
 fetch(

              
'https://aubpfeohfhuitytohjyu.supabase.co/functions/v1/hubtel-payment-proxy'
,

              {

                method: 
'POST'
,

                headers: { 
'Content-Type'
: 
'application/json'
 },

                body: JSON.stringify({

                  planSlug: planSlug,

                  customerEmail: email,

                  customerPhone: phone,

                  returnUrl: 
'https://checkout.biguncletech.com/result'
,

                  callbackUrl: 
'https://aubpfeohfhuitytohjyu.supabase.co/functions/v1/hubtel-callback'


                })

              }

            );

            addLog(`Edge Function response status: ${paymentResponse.status}`);

            
const
 responseText = 
await
 paymentResponse.text();

            addLog(`Edge Function raw response: ${responseText}`);

            
let
 result;

            
try
 {

              result = JSON.parse(responseText);

            } catch (parseError) {

              
throw
 
new
 Error(`Failed to parse response 
as
 JSON: ${parseError.message}`);

            }

            
if
 (paymentResponse.ok && result.checkoutUrl) {

              addLog(`Success! Redirecting to: ${result.checkoutUrl}`);

              setTimeout(() => {

                window.location.href = result.checkoutUrl;

              }, 
2000
);

            } 
else
 {

              
throw
 
new
 Error(result.error || result.details || 
'Payment initialisation failed'
);

            }

          } catch (err) {

            showError(
'Payment processing failed'
, err);

          }

        });

      } catch (err) {

        showError(
'Checkout initialisation failed'
, err);

      }

    }

    
// Start the checkout process


    initCheckout();

  </script>

</body>

</html>
