<!DOCTYPE html>
<html lang=
"en"
>
<head>
  <meta charset=
"UTF-8"
 />
  <meta name=
"viewport"
 content=
"width=device-width, initial-scale=1.0"
/>
  <title>Secure Checkout | Big Uncle Technologies</title>
  <style>
    body {
      margin: 
0
;
      padding: 
0
;
      font-family: 
"Segoe UI"
, Tahoma, Geneva, Verdana, sans-serif;
      background: 
#f5f8fc;

      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 
100
vh;
    }
    .card {
      background: white;
      border-radius: 
16
px;
      padding: 
3
rem 
2
rem;
      box-shadow: 
0
 
12
px 
32
px 
rgba
(
0
, 
0
, 
0
, 
0.08
)
;
      text-align: center;
      width: 
100
%;
      max-width: 
420
px;
    }
    h1 {
      color: 
#1a202c;

      margin-bottom: 
1
rem;
      font-size: 
1.8
rem;
    }
    
#status {

      font-size: 
1
rem;
      color: 
#4a5568;

      margin-bottom: 
2
rem;
    }
    .spinner {
      border: 
4
px solid 
#eee;

      border-top: 
4
px solid 
#007aff;

      border-radius: 
50
%;
      width: 
36
px;
      height: 
36
px;
      margin: 
0
 auto 
1
rem auto;
      animation: spin 
1
s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(
360
deg); }
    }
    .support {
      font-size: 
0.9
rem;
      color: 
#666;

      margin-top: 
1
rem;
    }
    .support a {
      color: 
#007aff;

      text-decoration: none;
    }
    .support a:hover {
      text-decoration: underline;
    }
    .form-
group
 {
      margin-bottom: 
1
rem;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 
0.5
rem;
      font-size: 
0.9
rem;
      color: 
#4a5568;

    }
    input {
      width: 
100
%;
      padding: 
0.75
rem;
      border: 
1
px solid 
#e2e8f0;

      border-radius: 
8
px;
      font-size: 
1
rem;
      box-sizing: border-box;
    }
    button {
      background: 
#007aff;

      color: white;
      border: none;
      border-radius: 
8
px;
      padding: 
0.75
rem 
1.5
rem;
      font-size: 
1
rem;
      cursor: pointer;
      width: 
100
%;
      margin-top: 
1
rem;
    }
    button:hover {
      background: 
#0056b3;

    }
    .hidden {
      display: none;
    }
  </style>
  <script type=
"module"
>
    import { createClient } 
from
 
'https://esm.sh/@supabase/supabase-js@2'
;
    
const
 supabase = createClient(
      
'https://aubpfeohfhuitytohjyu.supabase.co'
,
      
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1YnBmZW9oZmh1aXR5dG9oanl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMDc0MjgsImV4cCI6MjA2ODU4MzQyOH0.XYtk6yRoju-on48lWaudptFNyw7Or4IaGkAQY15jwzo'

    );
    window.onload = 
async
 () => {
      
const
 
params
 = 
new
 URLSearchParams(window.location.search);
      
const
 planSlug = 
params
.
get
(
"plan"
);
      
const
 status = document.getElementById(
"status"
);
      
const
 spinner = document.querySelector(
".spinner"
);
      
const
 checkoutForm = document.getElementById(
"checkout-form"
);
      
const
 planDetails = document.getElementById(
"plan-details"
);
      
const
 planNameElement = document.getElementById(
"plan-name"
);
      
const
 planAmountElement = document.getElementById(
"plan-amount"
);
      
if
 (!planSlug) {
        status.innerText = 
"No plan selected. Please go back and try again."
;
        spinner.style.display = 
"none"
;
        
return
;
      }
      status.innerText = 
"Retrieving plan details..."
;
      
try
 {
        
const
 { data: plan, error } = 
await
 supabase
          .rpc(
"get_pricing_plan_by_slug"
, { plan_slug: planSlug })
          .single();
        
if
 (error || !plan) {
          spinner.style.display = 
"none"
;
          status.innerText = 
"Invalid or inactive plan. Please contact support."
;
          
return
;
        }
        
// If no amount, assume Enterprise (Contact for pricing)

        
if
 (!plan.amount) {
          spinner.style.display = 
"none"
;
          status.innerHTML = `
            This plan requires a custom quote.<br/><br/>
            <a href=
"https://wa.me/233543899498"
 target=
"_blank"
>Click here to contact support</a>.
          `;
          
return
;
        }
        
// Show plan details and checkout form

        spinner.style.display = 
"none"
;
        status.style.display = 
"none"
;
        planNameElement.textContent = plan.name;
        planAmountElement.textContent = `${plan.currency} ${plan.amount.toFixed(
2
)}`;
        planDetails.classList.
remove
(
"hidden"
);
        checkoutForm.classList.
remove
(
"hidden"
);
        
// Set up form submission

        checkoutForm.addEventListener(
"submit"
, 
async
 (e) => {
          e.preventDefault();
          
const
 customerEmail = document.getElementById(
"email"
).
value
;
          
const
 customerPhone = document.getElementById(
"phone"
).
value
;
          
// Show loading state

          
const
 submitBtn = document.getElementById(
"submit-btn"
);
          
const
 originalBtnText = submitBtn.textContent;
          submitBtn.disabled = 
true
;
          submitBtn.textContent = 
"Processing..."
;
          status.textContent = 
"Connecting to secure payment gateway..."
;
          status.style.display = 
"block"
;
          spinner.style.display = 
"block"
;
          
try
 {
            
// Call the Edge Function with the correct payload structure

            
const
 response = 
await
 fetch(
              
"https://aubpfeohfhuitytohjyu.supabase.co/functions/v1/hubtel-payment-proxy"
,
              {
                method: 
"POST"
,
                headers: { 
"Content-Type"
: 
"application/json"
 },
                body: JSON.stringify({
                  planSlug: planSlug,
                  customerEmail: customerEmail,
                  customerPhone: customerPhone,
                  returnUrl: 
"https://biguncletech.com/payment-complete"
,
                  callbackUrl: 
"https://aubpfeohfhuitytohjyu.supabase.co/functions/v1/hubtel-callback"

                })
              }
            );
            
const
 result = 
await
 response.json();
            
if
 (result.success && result.checkoutUrl) {
              status.innerText = 
"Redirecting to secure payment page..."
;
              
// Store transaction ID in localStorage for later reference

              
if
 (result.transactionId) {
                localStorage.setItem(
"lastTransactionId"
, result.transactionId);
              }
              
// Redirect to Hubtel checkout page

              setTimeout(() => {
                window.location.href = result.checkoutUrl;
              }, 
1000
);
            } 
else
 {
              
throw
 
new
 Error(result.error || 
"Payment initialization failed"
);
            }
          } catch (err) {
            spinner.style.display = 
"none"
;
            status.innerText = 
"Something went wrong. Please try again or contact support."
;
            submitBtn.disabled = 
false
;
            submitBtn.textContent = originalBtnText;
            console.error(err);
          }
        });
      } catch (err) {
        spinner.style.display = 
"none"
;
        status.innerText = 
"Something went wrong. Please refresh or contact support."
;
        console.error(err);
      }
    };
  </script>
</head>
<body>
  <div 
class
=
"card"
>
    <div 
class
=
"spinner"
></div>
    <h1>Secure Checkout</h1>
    <p id=
"status"
>Preparing your checkout session...</p>
    <div id=
"plan-details"
 
class
=
"hidden"
>
      <h2>Plan: <span id=
"plan-name"
></span></h2>
      <p>Amount: <strong id=
"plan-amount"
></strong></p>
    </div>
    <form id=
"checkout-form"
 
class
=
"hidden"
>
      <div 
class
=
"form-group"
>
        <label 
for
=
"email"
>Email Address</label>
        <input type=
"email"
 id=
"email"
 required placeholder=
"your@email.com"
>
      </div>
      <div 
class
=
"form-group"
>
        <label 
for
=
"phone"
>
Phone 
Number
 (
with
 country code
)</label>
        <input type
=
"tel"
 id=
"phone"
 placeholder=
"e.g., 233543899498"
 required>
      </div>
      <button type=
"submit"
 id=
"submit-btn"
>Proceed to Payment</button>
    </form>
    <div 
class
=
"support"
>
      Need help? <a href=
"https://wa.me/233543899498"
 target=
"_blank"
>Contact Support</a>
    </div>
  </div>
</body>
</html>
